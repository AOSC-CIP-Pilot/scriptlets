#!/bin/bash -e

ARGS_SSH=""
ARGS_RSYNC=""
AFTER_CLEAN_DIRECTORY=0

while getopts "hvd" arg ; do
    case $arg in
        h)
            _help_message
            exit 0
            ;;
        v)
            ARGS_SSH+=" -vvv"
            ARGS_RSYNC+=" -v"
            ;;
        d)
            AFTER_CLEAN_DIRECTORY=1
            ;;
        ?)
            _help_message
            exit 1
            ;;
    esac
done

shift "$((OPTIND-1))"

USERNAME="$1"
BRANCH="$2"
COMPOMENT="${3:-main}"

_help_message() {
    cat << EOF
Usage:

	pushpkg <LDAP_USERNAME> <BRANCH> [COMPONENT]

	LDAP_USERNAME: Your LDAP username.
	BRANCH: AOSC OS update branch (stable, stable-proposed, testing, etc.)

Options:

    [COMPONENT]: (Optional) Repository component (main, bsp-sunxi, etc.)
                 Falls back to \"main\" if not specified.
    -d: Clean OUTPUT directory after finishing uploading.
    -v: Enable verbose logging for ssh and rsync

EOF
}

if [[ -z $USERNAME || -z $BRANCH ]]; then
    echo "[!!!] Please specify a LDAP user and specify a branch!"
    _help_message
    exit 1
fi

if [[ ! -d 'debs' ]]; then
    echo "[!!!] debs is not a directory."
    exit 1
fi

OUTPUT_DIR="$(readlink -f debs)"
sudo find "${OUTPUT_DIR}" -maxdepth 1 -type f -delete -print

ssh ${ARGS_SSH} "${USERNAME}@repo.aosc.io" "mkdir -p '/mirror/debs/pool/${BRANCH}/${COMPOMENT}'"

pushd "$OUTPUT_DIR"
NOARCH_LIST_PATH="$(mktemp)"
find . -name '*_noarch.deb' -print > "$NOARCH_LIST_PATH"
rsync ${ARGS_RSYNC} -rlOvhze ssh --progress --exclude-from "$NOARCH_LIST_PATH" . "${USERNAME}@repo.aosc.io:/mirror/debs/pool/${BRANCH}/${COMPOMENT}/"
rsync ${ARGS_RSYNC} -rlOvhze ssh --progress --ignore-existing --files-from "$NOARCH_LIST_PATH" . "${USERNAME}@repo.aosc.io:/mirror/debs/pool/${BRANCH}/${COMPOMENT}/"
popd

rm -v "$NOARCH_LIST_PATH"

if [ $AFTER_CLEAN_DIRECTORY = 1 ]; then
    sudo rm -rv "$OUTPUT_DIR"
fi
