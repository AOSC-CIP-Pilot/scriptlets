#!/bin/bash -e

ARGS_SSH=""
ARGS_RSYNC=""
AFTER_CLEAN_DIRECTORY=0
USERNAME=""
BRANCH=""
COMPOMENT=""

while getopts "hvdb:u:c:" arg ; do
    case $arg in
        h)
            _help_message
            exit 0
            ;;
        v)
            ARGS_SSH+=" -vvv"
            ARGS_RSYNC+=" -v"
            ;;
        d)
            AFTER_CLEAN_DIRECTORY=1
            ;;
        b)
            BRANCH=${OPTARG}
            ;;
        u)
            USERNAME=${OPTARG}
            ;; 
        c)
            COMPOMENT=${OPTARG}
            ;;
        ?)
            _help_message
            exit 1
            ;;
    esac
done


_help_message() {
    printf "\
Usage:

	pushpkg -u LDAP_USERNAME -b BRANCH -c [COMPONENT]

	-u LDAP_USERNAME: Your LDAP username.
	-b BRANCH: AOSC OS update branch (stable, stable-proposed, testing, etc.)

Options:

    -c: [COMPONENT]: (Optional) Repository component (main, bsp-sunxi, etc.)
                       Falls back to "main" if not specified.
    -d: pushpkg after clean OUTPUT directory
    -v: ssh and rsync verbose

"
}

if [[ -z $USERNAME || -z $BRANCH ]]; then
    echo -e "[!!!] Please specify a LDAP user and specify a branch!\n"
    _help_message
    exit 1
fi

if [ -z $COMPOMENT ]; then
    COMPOMENT="main"
fi

ssh ${ARGS_SSH} ${USERNAME}@repo.aosc.io "mkdir -p /mirror/debs/pool/${BRANCH}/${COMPOMENT}"

for i in debs/*/*; do
    if [ $i = "*_noarch.deb" ]; then
        rsync ${ARGS_RSYNC} --ignore-existing -rlOvhze ssh --progress $i ${USERNAME}@repo.aosc.io:/mirror/debs/pool/${BRANCH}/${COMPOMENT}
    else
        rsync ${ARGS_RSYNC} -rlOvhze ssh --progress $i ${USERNAME}@repo.aosc.io:/mirror/debs/pool/${BRANCH}/${COMPOMENT}
    fi
done

if [ $AFTER_CLEAN_DIRECTORY = 1 ]; then
     rm -rfv ./*
fi
