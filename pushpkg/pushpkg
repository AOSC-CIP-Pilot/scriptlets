#!/usr/bin/python3

import argparse
import os
import subprocess
import sys


def main():
    parser = argparse.ArgumentParser(
        description="pushpkg, push aosc package to repo.aosc.io")
    parser.add_argument("username", metavar="USERNAME", type=str,
                        help="Your LDAP username.")
    parser.add_argument("branch", metavar="BRANCH", type=str,
                        help="AOSC OS update branch (stable, stable-proposed, testing, etc.)")
    parser.add_argument("component", metavar="COMPONENT",
                        type=str, help="(Optional) Repository component (main, bsp-sunxi, etc.) Falls back to \"main\" if not specified.", nargs="?", default="main")
    parser.add_argument("-v", "--verbose", action="store_true",
                        help="Enable verbose logging for ssh and rsync")
    parser.add_argument("-d", "--delete", action="store_true",
                        help="Clean OUTPUT directory after finishing uploading.")
    parser.add_argument("-f", "--force-push-noarch-package", action="store_true",
                        help="Force Push noarch packahe.")
    args = parser.parse_args()
    if not args.username or not args.branch:
        print("[!!!] Please specify a LDAP user and specify a branch!")
        parser.print_help()
        sys.exit(1)
    if not os.path.isdir("./debs"):
        print("[!!!] debs is not a directory!")
        sys.exit(1)
    delete_junk()
    rsync_non_noarch_file(args.username, args.branch,
                          args.component, args.verbose)
    if have_noarch_files():
        rsync_noarch_file(args.username, args.branch, args.component,
                          args.verbose, args.force_push_noarch_package)
    if args.delete:
        clean_output_directory()
    mark_upload_done(args.username, args.verbose)
    return


def delete_junk():
    debs_path = os.path.abspath("./debs")
    command = ["sudo", "find", debs_path, "-maxdepth",
               "1", "-type", "f", "-delete", "-print"]
    subprocess.check_call(command)


def mark_upload_done(username: str, verbose=False):
    command = ["ssh", f"{username}@repo.aosc.io", "touch", "/mirror/.updated"]
    if verbose:
        command.insert(1, "-v")
    subprocess.check_call(command)


def rsync_non_noarch_file(username: str, branch: str, component: str, verbose=False):
    command = ["rsync", "-rlOvhzPe", "ssh", "--exclude", "--mkpath",
               "*_noarch.deb", "./debs/", f"{username}@repo.aosc.io:/mirror/debs/pool/{branch}/{component}/"]
    if verbose:
        command.insert(1, "-v")
    subprocess.check_call(command)


def have_noarch_files() -> bool:
    output = subprocess.check_output(["find", "./debs", "-name", "*_noarch.deb"])
    return len(output) < 1


def rsync_noarch_file(username: str, branch: str, component: str, verbose=False, force_push_noarch_package=False):
    command = ["rsync", "--ignore-existing", "-rlOvhzPe", "ssh", "--include",
               "*_noarch.deb", "./debs/", f"{username}@repo.aosc.io:/mirror/debs/pool/{branch}/{component}/"]
    if force_push_noarch_package:
        del command[1]
    if verbose:
        command.insert(1, "-v")
    subprocess.check_call(command)


def clean_output_directory():
    print("Cleaning debs...")
    debs_path = os.path.abspath("./debs")
    subprocess.check_call(["sudo", "rm", "-rv", debs_path])


if __name__ == "__main__":
    main()
